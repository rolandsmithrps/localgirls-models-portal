<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Model Room</title>
<style>body{background:#0f0a1f;color:#f8f8ff;font-family:ui-sans-serif}header{background:#4c1d95;padding:10px 14px}.pill{border:1px solid #fff3;border-radius:999px;padding:2px 6px}.wrap{display:grid;grid-template-columns:2fr 1fr;gap:10px;margin:10px}video{width:100%;background:#000;border:1px solid #3a1b73;border-radius:12px}.panel{background:#1e103b;border:1px solid #3a1b73;border-radius:12px;padding:10px;height:70vh;display:flex;flex-direction:column}.debug{font-size:.85rem;color:#cbd5e1;margin-top:6px;white-space:pre-line}</style>
<script src="https://cdn.ably.com/lib/ably.min-1.js"></script></head><body>
<header>LOCAL GIRLS â€” Model Room <span class=pill>v8.3</span> <span id=roomName></span></header>
<div class=wrap><div><video id=remote autoplay playsinline muted></video><div id=debug class=debug></div></div><div class=panel><video id=local autoplay muted playsinline></video></div></div>
<script>
const dbgEl=document.getElementById('debug'); const log=m=>{const p=document.createElement('div'); p.textContent=m; dbgEl.appendChild(p)};
const roomSlug=location.pathname.split('/room/')[1]?.split('?')[0]||'room'; const isHost=new URLSearchParams(location.search).has('host'); document.getElementById('roomName').textContent='Room: '+roomSlug+(isHost?' (host)':'');
let pc, dc, realtime, chan; let localStream=null; const remoteStream=new MediaStream(); const remoteV=document.getElementById('remote'); remoteV.srcObject=remoteStream;
async function getIceServers(){ try{ const r=await fetch('/api/ice',{cache:'no-store'}); const j=await r.json(); log('ICE '+JSON.stringify(j.iceServers)); return j.iceServers||[{urls:['stun:stun.l.google.com:19302']}]; }catch(e){ return [{urls:['stun:stun.l.google.com:19302']}]; } }
async function initPeer(servers){ pc=new RTCPeerConnection({iceServers:servers}); pc.ontrack=e=>{ if(e.track){ remoteStream.addTrack(e.track); remoteV.play().catch(()=>{}); log('ontrack '+e.track.kind); } }; pc.onicecandidate=e=>{ if(e.candidate) chan.publish('ice', e.candidate); }; pc.onnegotiationneeded=async()=>{ try{ if(pc.signalingState!=='stable') return; const offer=await pc.createOffer(); await pc.setLocalDescription(offer); chan.publish('sdp', pc.localDescription); log('offer ->'); }catch(e){ log('neg err '+e.message); } };
  try{ localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true}); localStream.getTracks().forEach(t=>pc.addTrack(t, localStream)); document.getElementById('local').srcObject=localStream; log('host: tracks added'); }catch(e){ log('media err '+e.message); }
  dc=pc.createDataChannel('chat'); }
(async()=>{ const ice=await getIceServers(); realtime=new Ably.Realtime.Promise({authUrl:'/api/ably-token'}); await realtime.connection.once('connected'); chan=realtime.channels.get('room:'+roomSlug);
  chan.subscribe('ice', async c=>{ try{ await pc.addIceCandidate(new RTCIceCandidate(c.data)); log('ice <-'); }catch(e){} }); chan.subscribe('sdp', async s=>{ const d=s.data; if(d.type==='offer'){ log('offer <-'); await pc.setRemoteDescription(d); const ans=await pc.createAnswer(); await pc.setLocalDescription(ans); chan.publish('sdp', pc.localDescription); log('answer ->'); } else if(d.type==='answer'){ log('answer <-'); await pc.setRemoteDescription(d); } }); await initPeer(ice); const off=await pc.createOffer(); await pc.setLocalDescription(off); chan.publish('sdp', pc.localDescription); log('initial offer ->'); })();
</script></body></html>
