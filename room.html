<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Model Room</title>
  <style>
    :root { --bg:#0f0a1f; --card:#17122b; --acc:#6d28d9; --text:#f8f8ff; --muted:#cbd5e1; --warn:#f59e0b; --err:#ef4444; }
    body{background:var(--bg);color:var(--text);font-family:ui-sans-serif;margin:0}
    header{background:#4c1d95;padding:10px 14px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .pill{border:1px solid #fff3;border-radius:999px;padding:2px 8px}
    .wrap{display:grid;grid-template-columns:2fr 1fr;gap:10px;margin:10px}
    video{width:100%;background:#000;border:1px solid #3a1b73;border-radius:12px}
    .panel{background:#1e103b;border:1px solid #3a1b73;border-radius:12px;padding:10px;height:72vh;display:flex;flex-direction:column;gap:10px}
    .debug{font-size:.85rem;color:var(--muted);margin-top:6px;white-space:pre-line}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #5b21b6;background:var(--acc);color:#fff;cursor:pointer}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .badge{display:inline-flex;gap:6px;align-items:center;border:1px solid #ffffff29;border-radius:999px;padding:4px 10px}
    .note{padding:8px 10px;border-radius:10px;border:1px solid #5b21b6;background:#1a1433;color:var(--muted)}
    .warn{border-color:#a16207;color:#fde68a}
    .err{border-color:#9f1239;color:#fecaca}
  </style>
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
</head>
<body>
<header>
  <div>
    <strong>LOCAL GIRLS â€” Model Room</strong>
    <span class="pill" id="roomName">Room</span>
    <span class="pill" id="presencePill" title="Connected participants">0 online</span>
  </div>
  <div class="toolbar">
    <button id="btnStart" class="btn">Start Cam & Mic</button>
    <button id="btnConnect" class="btn">Connect</button>
    <button id="btnMute" class="btn">Mute</button>
    <button id="btnCam" class="btn">Camera Off</button>
    <button id="btnHang" class="btn">Hang Up</button>
  </div>
</header>

<div class="wrap">
  <div>
    <video id="remote" autoplay playsinline></video>
    <div id="debug" class="debug"></div>
    <div id="diag" class="note warn" style="display:none"></div>
  </div>
  <div class="panel">
    <video id="local" autoplay muted playsinline></video>
    <div class="badge" id="connState">Peer: disconnected</div>
  </div>
</div>

<script>
const dbgEl = document.getElementById('debug');
const diagEl = document.getElementById('diag');
const log = (m) => { const p=document.createElement('div'); p.textContent = m; dbgEl.appendChild(p) };
const diag = (m, cls='warn') => { diagEl.className = 'note ' + cls; diagEl.textContent = m; diagEl.style.display = 'block'; };

const roomSlug = location.pathname.split('/room/')[1]?.split('?')[0] || 'room';
const isHost = new URLSearchParams(location.search).has('host');
document.getElementById('roomName').textContent = 'Room: ' + roomSlug + (isHost ? ' (host)' : '');

let pc, dc, realtime, chan;
let localStream = null;
const remoteStream = new MediaStream();
const remoteV = document.getElementById('remote'); remoteV.srcObject = remoteStream;

const presEl = document.getElementById('presencePill');
const stateEl = document.getElementById('connState');
function setPresence(n){ presEl.textContent = (n|0) + ' online'; }
function setState(s){ stateEl.textContent = 'Peer: ' + s; }

// Preflight diagnostics
(function preflight(){
  if (!window.isSecureContext) {
    diag('This page is not running in a secure context. getUserMedia requires HTTPS (or localhost).', 'err');
  }
  if (window.top !== window && !document.hasFocus()) {
    // embedded in iframe; remind about permissions
    diag('Embedded in an iframe: ensure the iframe has allow="camera; microphone; autoplay" and the parent site Permissions-Policy allows camera/microphone for this origin.');
  }
})();

async function getIceServers(){
  try{
    const r = await fetch('/api/ice', { cache:'no-store' });
    const j = await r.json();
    log('ICE ' + JSON.stringify(j.iceServers));
    return j.iceServers || [{ urls:['stun:stun.l.google.com:19302'] }];
  }catch(e){
    return [{ urls:['stun:stun.l.google.com:19302'] }];
  }
}

async function initPeer(servers){
  pc = new RTCPeerConnection({ iceServers: servers });
  pc.ontrack = e => {
    if (e.track) {
      remoteStream.addTrack(e.track);
      remoteV.play().catch(()=>{});
      log('ontrack ' + e.track.kind);
    }
  };
  pc.onicecandidate = e => { if (e.candidate) chan.publish('ice', e.candidate); };
  pc.onconnectionstatechange = () => { setState(pc.connectionState); log('pc state: ' + pc.connectionState); };
  dc = pc.createDataChannel('chat');
}

(async () => {
  const ice = await getIceServers();
  realtime = new Ably.Realtime.Promise({ authUrl: '/api/ably-token' });
  await realtime.connection.once('connected');
  chan = realtime.channels.get('room:' + roomSlug);

  try { await chan.presence.enter({ role: isHost ? 'host' : 'guest' }); } catch(e){ log('presence error ' + e.message); }

  chan.presence.subscribe(['enter','leave','update'], async () => {
    const members = await chan.presence.get();
    setPresence(members.length);
  });
  try { const members = await chan.presence.get(); setPresence(members.length); } catch {}

  chan.subscribe('ice', async c => { try { await pc.addIceCandidate(new RTCIceCandidate(c.data)); log('ice <-'); } catch(e){} });
  chan.subscribe('sdp', async s => {
    const d = s.data;
    if (d.type === 'offer') {
      log('offer <-');
      await pc.setRemoteDescription(d);
      const ans = await pc.createAnswer();
      await pc.setLocalDescription(ans);
      chan.publish('sdp', pc.localDescription);
      log('answer ->');
    } else if (d.type === 'answer') {
      log('answer <-');
      await pc.setRemoteDescription(d);
    }
  });

  await initPeer(ice);

  // Keep presence warm for external polling
  setInterval(() => { fetch('/api/presence?room=' + encodeURIComponent(roomSlug)).catch(()=>{}); }, 30000);
})();

async function startMedia(){
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ width:{ ideal:1280 }, height:{ ideal:720 } },
      audio:{ echoCancellation:true, noiseSuppression:true }
    });
    localStream = stream;
    stream.getTracks().forEach(t => pc.addTrack(t, stream));
    document.getElementById('local').srcObject = stream;
  } catch(e){
    const msg = (e && e.name ? e.name+': ' : '') + (e && e.message ? e.message : e);
    log('getUserMedia error ' + msg);
    diag('Camera/Mic failed: ' + msg + '\nTip: Click the camera icon in the address bar and set to "Allow". If embedded, add iframe allow="camera; microphone; autoplay".', 'err');
    throw e;
  }
}

async function makeOffer(){
  const offer = await pc.createOffer({ offerToReceiveAudio:true, offerToReceiveVideo:true });
  await pc.setLocalDescription(offer);
  chan.publish('sdp', pc.localDescription);
  log('offer ->');
}

document.getElementById('btnStart').onclick = async () => { await startMedia(); };
document.getElementById('btnConnect').onclick = async () => { await makeOffer(); };
document.getElementById('btnMute').onclick = () => {
  if (!localStream) return;
  const tracks = localStream.getAudioTracks();
  tracks.forEach(t => t.enabled = !t.enabled);
  document.getElementById('btnMute').textContent = tracks[0]?.enabled ? 'Mute' : 'Unmute';
};
document.getElementById('btnCam').onclick = () => {
  if (!localStream) return;
  const tracks = localStream.getVideoTracks();
  tracks.forEach(t => t.enabled = !t.enabled);
  document.getElementById('btnCam').textContent = tracks[0]?.enabled ? 'Camera Off' : 'Camera On';
};
document.getElementById('btnHang').onclick = async () => {
  try {
    if (localStream) localStream.getTracks().forEach(t => t.stop());
    if (pc) { pc.getSenders().forEach(s => s.track && s.track.stop()); pc.close(); }
    pc = null;
    document.getElementById('local').srcObject = null;
    if (remoteV.srcObject) { const s = remoteV.srcObject; s.getTracks().forEach(t => t.stop()); remoteV.srcObject = null; }
    try { await chan.presence.update({ state: 'idle' }); } catch {}
  } catch {}
};

window.addEventListener('beforeunload', async () => { try { await chan?.presence?.leave(); } catch {} });
</script>
</body>
</html>
