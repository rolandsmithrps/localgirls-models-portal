<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local Girls — Model Room</title><link rel="icon" href="data:," />
  <style>
    :root { --bg:#0f0a1f; --panel:#1e103b; --accent:#a855f7; --text:#f8f8ff; --muted:#cbd5e1; --border:#3a1b73; }
    *{box-sizing:border-box} body{margin:0;background:#0f0a1f;color:#f8f8ff;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{background:#4c1d95;padding:10px 14px;color:#fff;display:flex;align-items:center;justify-content:space-between}
    .wrap{display:grid;grid-template-columns:2fr 1fr;gap:10px;max-width:1400px;margin:10px auto;padding:10px}
    video{width:100%;background:#000;border-radius:12px;border:1px solid #3a1b73}
    .panel{background:#1e103b;border:1px solid #3a1b73;border-radius:12px;padding:10px;height:70vh;display:flex;flex-direction:column}
    .chat{flex:1;overflow:auto;border:1px solid #3a1b73;border-radius:8px;padding:8px;background:#160c2d;margin-bottom:8px}
    .chat .msg{margin:6px 0}
    .controls{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:6px}
    .iconbtn{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:8px;border:1px solid #3a1b73;background:#150a2b;color:#fff;cursor:pointer}
    .pill{font-weight:600;font-size:.85rem;padding:3px 6px;border:1px solid #ffffff33;border-radius:999px;opacity:.9}
    .debug{font-size:.85rem;color:#cbd5e1;margin-top:6px;white-space:pre-line}
  </style>
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
</head>
<body>
  <header>
    <div><b>LOCAL GIRLS — Model Room</b> <span class="pill">v8.2</span></div>
    <div id="roomName"></div>
  </header>

  <div class="wrap">
    <div>
      <video id="remote" autoplay playsinline muted></video>
      <div class="debug" id="debug"></div>
    </div>
    <div class="panel">
      <video id="local" autoplay playsinline muted></video>
      <div class="chat" id="chat"></div>
      <div class="controls">
        <input id="msg" placeholder="Type a message…" style="flex:1"/>
        <button id="send" class="iconbtn">Send</button>
        <button id="ping" class="iconbtn">Ping</button>
      </div>
    </div>
  </div>

<script>
function q(s){return document.querySelector(s)}
const dbgEl=q('#debug'); function dbg(m){const p=document.createElement('div');p.textContent=m;dbgEl.appendChild(p);}
const roomSlug=location.pathname.split('/room/')[1]?.split('?')[0]||'room';
const isHost = new URLSearchParams(location.search).has('host');
q('#roomName').textContent='Room: '+roomSlug+(isHost?' (host)':''); 

let pc, dc, realtime, chan;
let localStream=null; const remoteStream=new MediaStream(); q('#remote').srcObject=remoteStream;

async function getIceServers(){
  try{ const r=await fetch('/api/ice',{cache:'no-store'}); const j=await r.json(); return j.iceServers||[{urls:['stun:stun.l.google.com:19302']}]; }
  catch(e){ return [{urls:['stun:stun.l.google.com:19302']}]; }
}

async function initPeer(iceServers){
  pc=new RTCPeerConnection({iceServers});
  pc.ontrack=e=>{ if(e.track){ remoteStream.addTrack(e.track); q('#remote').play().catch(()=>{}); dbg('ontrack: '+e.track.kind); } };
  pc.onicecandidate=e=>{ if(e.candidate) chan.publish('ice', e.candidate); };
  pc.onnegotiationneeded=async()=>{
    try{
      if(pc.signalingState!=='stable')return;
      const offer=await pc.createOffer(); await pc.setLocalDescription(offer);
      chan.publish('sdp', pc.localDescription); dbg('offer ->');
    }catch(e){ dbg('neg err: '+e.message); }
  };

  // Host/model: capture immediately
  try{
    localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
    q('#local').srcObject=localStream;
    dbg('host: tracks added');
  }catch(e){ dbg('media err: '+e.message); }

  // Data channel
  dc=pc.createDataChannel('chat');
  dc.onmessage=(e)=>{const d=document.createElement('div'); d.textContent='Peer: '+e.data; q('#chat').appendChild(d); };
}

async function init(){
  const iceServers=await getIceServers(); dbg('ICE '+JSON.stringify(iceServers));
  realtime=new Ably.Realtime.Promise({authUrl:'/api/ably-token'});
  await realtime.connection.once('connected');
  chan=realtime.channels.get('room:'+roomSlug);

  chan.subscribe('ice', async cand => { try{ await pc.addIceCandidate(new RTCIceCandidate(cand.data)); dbg('ice <-'); }catch(e){} });
  chan.subscribe('sdp', async s => {
    const desc=s.data;
    if(desc.type==='offer'){ dbg('offer <-'); await pc.setRemoteDescription(desc); const ans=await pc.createAnswer(); await pc.setLocalDescription(ans); chan.publish('sdp', pc.localDescription); dbg('answer ->');}
    else if(desc.type==='answer'){ dbg('answer <-'); await pc.setRemoteDescription(desc); }
  });

  await initPeer(iceServers);

  // Kick initial offer now (host)
  const offer=await pc.createOffer(); await pc.setLocalDescription(offer); chan.publish('sdp', pc.localDescription); dbg('initial offer ->');
}
init();
</script>
</body></html>
