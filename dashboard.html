<!doctype html>
<html lang="en">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Local Girls — Model Dashboard</title><link rel="icon" href="data:,"/><style>
:root { --bg:#0f0a1f; --panel:#1e103b; --accent:#a855f7; --text:#f8f8ff; --muted:#cbd5e1; --border:#3a1b73; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
a{color:#fff;text-decoration:none}
header{background:#4c1d95;padding:12px 16px;color:#fff;display:flex;align-items:center;justify-content:space-between}
.brand{font-weight:800;letter-spacing:.5px}
.badge{font-weight:600;font-size:.85rem;padding:4px 8px;border:1px solid #ffffff33;border-radius:999px;opacity:.9;margin-left:8px}
.btn{padding:10px 14px;border-radius:10px;border:1px solid #5b21b6;background:#6d28d9;color:#fff;cursor:pointer}
.container{max-width:1100px;margin:0 auto;padding:18px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px}
input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#150a2b;color:#fff}
label{display:block;margin-bottom:6px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.stat{background:#150a2b;border:1px solid #3a1b73;border-radius:12px;padding:12px}
</style><script src="https://cdn.ably.com/lib/ably.min-1.js"></script></head>
<body>
<header><div class="brand">LOCAL GIRLS — Models <span class="badge">v8.2</span></div><a class="btn" href="/login.html">Switch</a></header>
<main class="container">
  <div class="panel">
    <h2 id="hello">Welcome</h2>
    <div style="display:flex;gap:10px;margin:10px 0">
      <button class="btn" id="goLive">Go Live</button>
      <button class="btn" id="end" style="display:none">End Stream</button>
    </div>
    <div class="grid2">
      <div class="stat"><b>Your Metrics</b><div>Total streams this month: 42 unique streams</div><div>Total Private minutes billed: 541 minutes</div><div>Total Exclusive Minutes Billed: 212 minutes</div><div>Total Tips: $987</div><div>Total Earnings: $4,789</div></div>
      <div class="stat"><b>Status</b><div id="status">Offline</div></div>
    </div>
  </div>
</main>

<script>
function slugify(s){return (s||'').toLowerCase().trim().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');}
const profile = JSON.parse(localStorage.getItem('lg_model')||'null');
if(!profile || !profile.name){ location.href='/login.html'; }
document.getElementById('hello').textContent = 'Welcome, ' + profile.name;

let streamWin = null;
let realtime = null;
let dirChan = null;
let hbTimer = null;
const handle = slugify(profile.name); // "taylored2u" expected
const isT = handle === 'taylored2u';
const statusEl = document.getElementById('status');

function startHeartbeat(){
  if (hbTimer) return;
  hbTimer = setInterval(()=>{ dirChan && dirChan.publish('join', { name: profile.name, handle }); }, 1000);
}
function stopHeartbeat(){
  clearInterval(hbTimer); hbTimer = null;
  dirChan && dirChan.publish('leave', { name: profile.name, handle });
}

async function initRealtime(){
  if (realtime) return;
  realtime = new Ably.Realtime.Promise({ authUrl: '/api/ably-token' });
  await realtime.connection.once('connected');
  dirChan = realtime.channels.get('directory');
}

document.getElementById('goLive').addEventListener('click', async ()=>{
  await initRealtime();
  startHeartbeat();
  statusEl.textContent = 'Online';
  document.getElementById('end').style.display='inline-flex';
  // Open host room on THIS domain to guarantee same code as members update we ship next
  const url = '/room/' + handle + '?host=1';
  streamWin = window.open(url, '_blank');
  if (!streamWin) alert('Please allow popups for Go Live');
});

document.getElementById('end').addEventListener('click', ()=>{
  stopHeartbeat();
  statusEl.textContent = 'Offline';
  if (streamWin && !streamWin.closed){
    streamWin.close();
  }
  document.getElementById('end').style.display='none';
});
</script>
</body></html>
